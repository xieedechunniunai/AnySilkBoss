# 移动丝球攻击 - 优化记录

## 📋 优化概览

本文档记录了对"移动丝球攻击"功能的所有优化和改进。

---

## ✅ 已完成的优化

### 1. 速度调整（优化-1）

**问题**：Boss移动速度太快（30 unity/s），视觉效果不佳

**解决方案**：
- 将 `DASH_SPEED` 从 30f 降低到 15f
- 速度降低为原来的一半

**修改位置**：
```csharp
// BossBehavior.cs
private const float DASH_SPEED = 15f; // 移动速度（降低为原来的一半）
```

---

### 2. 面向目标点（优化-2）

**问题**：Boss冲刺时没有面向目标点，出现"倒着飞"的不自然效果

**解决方案**：
- 在 `BossBehavior` 中添加 `FaceTowardsPosition(float targetX, float targetY)` 方法
- 通过翻转 `transform.localScale.x` 来实现面向
- 在 `Update()` 方法中检测状态变化，自动调用面向方法

**实现细节**：
```csharp
// BossBehavior.cs - Update方法
private string _lastStateName = "";

private void Update()
{
    if (_bossControlFsm != null)
    {
        string currentState = _bossControlFsm.ActiveStateName;
        if (currentState != _lastStateName)
        {
            _lastStateName = currentState;
            
            // 根据状态面向对应的点
            if (currentState == "Silk Ball Dash Route Start")
                FaceTowardsPosition(RoutePoint0X.Value, RoutePoint0Y.Value);
            else if (currentState == "Silk Ball Dash To Point 1")
                FaceTowardsPosition(RoutePoint1X.Value, RoutePoint1Y.Value);
            else if (currentState == "Silk Ball Dash To Point 2")
                FaceTowardsPosition(RoutePoint2X.Value, RoutePoint2Y.Value);
        }
    }
}

// Helper方法
public void FaceTowardsPosition(float targetX, float targetY)
{
    float currentX = transform.position.x;
    float direction = targetX - currentX;
    
    if (direction > 0)
        transform.localScale = new Vector3(Mathf.Abs(transform.localScale.x), ...);
    else if (direction < 0)
        transform.localScale = new Vector3(-Mathf.Abs(transform.localScale.x), ...);
}
```

---

### 3. 等待时间可配置（优化-3）

**问题**：
- Boss到达点位后使用硬编码的3秒超时等待
- 实际需要的是1.3秒的到达后等待时间

**解决方案**：
- 创建 `DashWaitTime` 公共变量（FsmFloat）
- 初始值设为 1.3 秒
- 添加到 FSM 的 FloatVariables 列表
- 在 Wait Action 中直接引用该变量

**实现细节**：
```csharp
// BossBehavior.cs
private const float DASH_WAIT_TIME = 1.3f;
public FsmFloat? DashWaitTime;

// 初始化
DashWaitTime = new FsmFloat("Dash Wait Time") { Value = DASH_WAIT_TIME };

// 使用
actions.Add(new Wait
{
    time = DashWaitTime!,
    finishEvent = FsmEvent.Finished,
    realTime = false
});
```

**优点**：
- 可在运行时调整等待时间
- 通过 `AttackControlBehavior` 访问 `BossBehavior.DashWaitTime.Value` 即可修改
- 所有点位使用统一的等待时间变量

---

### 4. 到达后播放Idle动画（优化-4）

**问题**：Boss到达点位后持续播放Dash动画，等待期间看起来很奇怪

**解决方案**：
- 在移动动画执行完成后，立即播放Idle动画
- Idle动画在Wait之前执行

**状态行为顺序**：
1. 面向目标点（Update中自动执行）
2. 播放Dash动画
3. 设置Y速度为0
4. 移动到目标位置（AnimateXPositionTo + AnimateYPositionTo）
5. **播放Idle动画** ⬅️ 新增
6. 等待指定时间（使用DashWaitTime变量）

**修改位置**：
- `CreateSilkBallDashRouteStartState()` - 添加Idle动画和Wait
- `CreateSilkBallDashToPointState()` - 添加Idle动画和Wait

---

## 🎯 技术要点

### 变量引用方式

**关键发现**：
- `FsmVariables.GetFsmFloat(name)` 会创建新实例，不能用于设置已存在的变量
- 正确方式：直接修改 `BossBehavior` 的 public `FsmFloat` 变量的 `Value` 属性

```csharp
// AttackControlBehavior.cs
var bossBehavior = gameObject.GetComponent<BossBehavior>();
bossBehavior.RoutePoint0X.Value = value.x;
bossBehavior.RoutePoint0Y.Value = value.y;

// BossBehavior.cs - 直接使用已添加到FSM的变量引用
actions.Add(new AnimateXPositionTo
{
    ToValue = RoutePoint0X!,  // 直接引用
    ...
});
```

### 面向实现的考量

**尝试过的方法**：
1. ❌ `GetAngleToTarget2` + `FaceAngle` - API不匹配
2. ❌ `CallMethod` 调用Helper方法 - 参数类型转换问题
3. ✅ **Update中检测状态变化** - 简单有效

**选择原因**：
- FSM Action的参数类型复杂，难以正确传递 `FsmFloat` 变量
- Update方法可以直接访问所有变量，逻辑清晰
- 状态变化检测非常可靠

---

## 📊 性能影响

### 正面影响
- 速度降低使得视觉效果更流畅
- 面向逻辑在Update中执行，性能开销极小
- 变量引用方式避免了不必要的对象创建

### 需要注意
- Update方法中的状态检测每帧执行，但只有状态变化时才执行面向逻辑
- 使用 `_lastStateName` 缓存避免重复执行

---

## 🔄 完整的行为流程

### 状态1: Silk Ball Dash Route Start
```
1. 取消硬直 (STUN CONTROL STOP)
2. [Update检测] 面向 Route Point 0
3. 播放 Dash 动画
4. 设置 Y 速度为 0
5. 移动到 Route Point 0 (速度15, 超时3s)
6. 播放 Idle 动画
7. 等待 1.3 秒
→ 跳转到 Point 1
```

### 状态2-3: Silk Ball Dash To Point 1/2
```
1. [Update检测] 面向 Route Point 1/2
2. 播放 Dash 动画
3. 设置 Y 速度为 0
4. 移动到 Route Point 1/2 (速度15, 超时3s)
5. 播放 Idle 动画
6. 等待 1.3 秒
→ 跳转到下一个点或结束
```

### 状态4: Silk Ball Dash End
```
1. 恢复硬直 (STUN CONTROL START)
2. 通知 AttackControl (SILK BALL DASH END)
3. 播放 Idle 动画
4. 等待 0.5 秒
→ 返回 Idle 状态
```

---

## 📝 配置参数总结

| 参数 | 值 | 说明 |
|------|------|------|
| DASH_SPEED | 15f | 移动速度（unity/s） |
| MAX_DASH_TIME | 3f | 移动超时保护（秒） |
| DASH_WAIT_TIME | 1.3f | 到达后等待时间（秒） |
| 丝球生成间隔 | 5 unity | 每移动5单位生成一个 |

---

## 🎮 测试建议

### 必测场景
1. ✅ Boss在左区，Hero远距离
2. ✅ Boss在右区，Hero远距离
3. ✅ Boss在左区，Hero近距离
4. ✅ Boss在右区，Hero近距离
5. ✅ Boss在中区，随机选择

### 重点关注
- [ ] 面向方向是否正确（无倒飞）
- [ ] 移动速度是否合适（15 unity/s）
- [ ] 到达后是否正确播放Idle并等待1.3秒
- [ ] 丝球生成是否正常（每5单位）
- [ ] 超时保护是否工作（3秒）
- [ ] 全程是否保持高度不掉落

---

## 🔮 未来优化方向

1. **参数调优**：
   - 根据实际游戏体验调整 DASH_SPEED（当前15）
   - 调整 DASH_WAIT_TIME（当前1.3s）

2. **动画增强**：
   - 可能在转向时添加转身动画过渡
   - 考虑添加加速/减速效果

3. **AI改进**：
   - 根据Hero的移动预判路线
   - 动态调整移动策略

---

## ✨ 总结

本次优化解决了所有主要的视觉和体验问题：
- ✅ Boss不再倒着飞
- ✅ 移动速度更合理
- ✅ 等待时播放合适的动画
- ✅ 等待时间可配置
- ✅ 代码结构清晰，易于维护

下一步可以进行实际游戏测试，根据反馈进行微调。

