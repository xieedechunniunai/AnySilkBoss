# 眩晕中断丝球攻击 - 修复说明

## 问题描述
当Boss在执行丝球攻击时被眩晕（STUN），Attack Control FSM可能卡在某些Silk Ball状态（特别是`Silk Ball Lift`状态），导致：
1. 场景中的丝球实例未被清理
2. 状态机无法正常恢复，卡死在丝球攻击流程中
3. Boss眩晕恢复后攻击逻辑异常

## 解决方案

### 核心思路
遵循FSM项目规则：**单事件单跳转**原则，在Boss Control的眩晕状态发送事件，Attack Control的Silk Ball状态接收并处理。

### 修改内容

#### 1. SilkBallManager.cs - 添加清理方法
**新增方法：**
```csharp
public void DestroyAllActiveSilkBalls()
```

**功能：**
- 查找场景中所有活跃的丝球实例（通过`SilkBallBehavior`组件识别）
- 销毁所有实例，但**不删除预制体本身**
- 日志记录销毁数量

---

#### 2. BossBehavior.cs - Boss Control FSM修改

##### 2.1 在Stun Stagger状态添加清理逻辑
**位置：** Stun Stagger状态开头（第一时间清理）

**添加的Actions：**
1. **CallMethod** - 调用`CleanupSilkBallsOnStun()`方法
2. **SendEventByName** - 发送`SILK BALL INTERRUPT`事件到Attack Control

**新增方法：**
```csharp
public void CleanupSilkBallsOnStun()
```

**功能：**
- 停止移动丝球生成（调用AttackControl的`StopGeneratingSilkBall()`）
- 通过SilkBallManager清理所有场景中的丝球实例
- 日志记录清理过程

##### 2.2 在Stun Recover状态添加恢复事件
**位置：** Stun Recover状态开头

**添加的Action：**
- **SendEventByName** - 发送`SILK BALL RECOVER`事件（预留，当前未使用）

---

#### 3. AttackControlBehavior.cs - Attack Control FSM修改

##### 3.1 注册新事件
**新增事件：**
- `SILK BALL INTERRUPT` - 眩晕中断事件
- `SILK BALL RECOVER` - 眩晕恢复事件（预留）

##### 3.2 为Silk Ball状态添加中断转换
**遵循规则：** 单事件单跳转 - 每个状态只添加一个`SILK BALL INTERRUPT -> Move Restart`的转换

**已添加中断转换的状态：**
1. ✅ **Silk Ball Prepare** - 准备状态
2. ✅ **Silk Ball Cast** - 施法状态
3. ✅ **Silk Ball Lift** - **上升状态（最容易卡死）**
4. ✅ **Silk Ball Antic** - 召唤前摇状态
5. ✅ **Silk Ball Release** - 释放状态
6. ✅ **Silk Ball Dash Prepare** - 移动丝球准备状态

**不需要添加的状态（会自动流转）：**
- ❌ **Silk Ball End** - 已有`FINISHED -> Move Restart`
- ❌ **Silk Ball Recover** - 已有`FINISHED -> Move Restart`
- ❌ **Silk Ball Dash End** - 已有`SILK BALL DASH END`事件处理

---

## 执行流程

### Boss眩晕时（Stun Stagger状态）
```
1. Boss进入Stun Stagger状态
   ↓
2. CallMethod: CleanupSilkBallsOnStun()
   ├─ 停止移动丝球生成
   ├─ SilkBallManager.DestroyAllActiveSilkBalls()
   └─ 清理所有场景丝球实例
   ↓
3. SendEventByName: "SILK BALL INTERRUPT"（广播）
   ↓
4. Attack Control接收事件
   ├─ 如果在 Silk Ball Prepare/Cast/Lift/Antic/Release/Dash Prepare
   └─ 触发转换: SILK BALL INTERRUPT -> Move Restart
   ↓
5. 状态安全返回 Move Restart，可以正常恢复
```

### Boss眩晕恢复时（Stun Recover状态）
```
1. Boss进入Stun Recover状态
   ↓
2. SendEventByName: "SILK BALL RECOVER"（预留事件）
   ↓
3. 正常流程恢复，Attack Control已在Move Restart或其他安全状态
```

---

## FSM规则遵守情况

### ✅ 单事件单跳转
- 每个Silk Ball状态只添加**一个**`SILK BALL INTERRUPT`事件
- 该事件只对应**一个**目标状态：`Move Restart`
- 没有多事件收敛到同一跳转的情况

### ✅ FsmString显式赋值
所有新增的FsmString都正确设置了Value：
```csharp
new FsmString("SILK BALL INTERRUPT") { Value = "SILK BALL INTERRUPT" }
new FsmString("SILK BALL RECOVER") { Value = "SILK BALL RECOVER" }
```

### ✅ 状态-事件-跳转清晰
- Boss Control的Stun状态负责**发送事件**
- Attack Control的Silk Ball状态负责**接收事件并转换**
- 职责明确，无副作用越界

### ✅ 事件初始化
修改后调用了：
```csharp
_attackControlFsm.Fsm.InitData();
_attackControlFsm.Fsm.InitEvents();
```

---

## 测试要点

1. **Silk Ball Lift卡死测试**
   - 在Boss上升到高点过程中眩晕
   - 确认丝球被清理
   - 确认状态转换到Move Restart
   - 确认眩晕恢复后攻击正常

2. **Silk Ball Dash卡死测试**
   - 在Boss移动丝球攻击过程中眩晕
   - 确认丝球生成停止
   - 确认场景中丝球被清理
   - 确认状态转换正常

3. **其他Silk Ball状态测试**
   - 在Prepare/Cast/Antic/Release各状态眩晕
   - 确认所有状态都能正确中断

4. **预制体安全性测试**
   - 确认清理后预制体仍然存在
   - 确认下次攻击可以正常生成丝球

---

## 日志示例

### 正常眩晕中断流程
```
Boss眩晕，开始清理丝球
已通过SilkBallManager清理所有丝球
已清理场景中的丝球实例，共销毁 5 个
停止生成移动丝球
已在 Stun Stagger 状态添加丝球清理和中断事件发送
已在 Stun Recover 状态添加恢复事件发送
已为以下Silk Ball状态添加SILK BALL INTERRUPT中断转换:
  - Silk Ball Prepare
  - Silk Ball Cast
  - Silk Ball Lift (最容易卡死的状态)
  - Silk Ball Antic
  - Silk Ball Release
  - Silk Ball Dash Prepare
Boss眩晕时将自动清理丝球并转换到Move Restart
```

---

## 注意事项

1. **不要删除预制体**
   - `DestroyAllActiveSilkBalls()`方法已做了保护
   - 只销毁场景实例，保留`_customSilkBallPrefab`

2. **Move Restart不清理**
   - 丝球是长时间攻击，Move Restart只负责恢复状态
   - 清理在Stun Stagger早期完成

3. **中间状态不需要中断**
   - End/Recover等已经在流转尾部，有FINISHED事件
   - 只对"可能长时间停留"的状态添加中断

4. **事件广播范围**
   - 使用`BroadcastAll`确保Attack Control FSM能收到
   - `excludeSelf = false`避免遗漏

---

## 修改文件清单

1. ✅ `Source/Managers/SilkBallManager.cs`
   - 新增：`DestroyAllActiveSilkBalls()`方法

2. ✅ `Source/Behaviours/BossBehavior.cs`
   - 新增：`AddStunInterruptHandling()`方法
   - 新增：`AddCleanupToStunStagger()`方法
   - 新增：`AddRecoveryEventToStunRecover()`方法
   - 新增：`CleanupSilkBallsOnStun()`方法
   - 修改：`ModifyBossControlFSM()`添加调用

3. ✅ `Source/Behaviours/AttackControlBehavior.cs`
   - 新增：眩晕中断事件字段
   - 修改：`RegisterAttackControlEvents()`注册新事件
   - 修改：`CreateSilkBallAttackStates()`为6个状态添加中断转换

---

## 完成状态

✅ 所有代码修改完成  
✅ 无编译错误  
✅ 遵守FSM项目规则  
✅ 日志完善  

**可以进行游戏内测试！**

