---
alwaysApply: true
---
FSM / PlayMaker 项目规则（面向实现与审查，AI 必须遵守）

## 总则（先读这一段）
- **回复语言**：所有回复一律使用简体中文。
- **适用范围**：本项目内所有与 PlayMakerFSM 、状态/事件/跳转设计、Actions 组织，以及 `FsmString` 等相关数据结构的实现与审查。
- **MOD 参考资料**：由于我们这里是在制作 MOD，`@bin\Debug\temp` 里有一些原版的反编译文件可供参考；如需对齐原版行为，可以在该目录中搜索关键字定位实现。
- **默认修改目标**：如果我没有单独说明，“修改 BOSS 状态”默认指 **记忆版 BOSS**，即修改 `Source\Behaviours\Memory\` 下的文件。

## 术语（回答/代码注释中保持一致）
- **FSM 名称**：状态机实例的逻辑名称。
- **GameObject 名称**：承载该 FSM 的 Unity 对象名。
- **状态（State）**：FSM 的节点。
- **事件（Event）**：触发状态跳转的信号。
- **跳转（Transition）**：从状态 A 通过某事件到状态 B 的边。
- **Actions**：某个 State 内的行为列表。
- **FINISHED**：PlayMaker 的默认结束事件（当 State 内瞬发行为执行完毕会触发），**禁止**把它当作“多路通配事件”使用。

## 核心建模约束（强制，违背即视为错误）
1) **一事件一跳转**：从状态 A 跳到状态 B，必须通过**唯一的一个事件**完成。
2) **禁止多事件收敛**：不要让多个不同事件都指向同一目标状态 B。
   - 例：检测物体碰墙/碰玩家时，不能“碰墙触发事件1 → B、碰玩家触发事件2 → 也到 B”。必须拆分为不同目标状态，或用中间状态显式分流/汇合，保持「一事件一跳转」不变。
3) **复杂分支必须用中间状态拆分**：不要用“在一个状态上挂很多事件都指向同一个后继状态”来偷懒。
4) **禁止把 FINISHED 当作多路通配**：FINISHED 只能表达“该状态的瞬发动作完成”，不允许承担分支路由职责。

## PlayMaker 执行语义（重要，避免逻辑误判）
- **State 进入后**会按顺序执行该 State 的**所有瞬发性 Actions**，然后再进入持续性行为；进入持续阶段后会“锁住当前状态”。
- 因此：**把某个动作放到 Wait 后面，并不能保证它按你想象的方式延后触发**（需要通过状态拆分来表达时序）。
- **纯瞬发 Action 的 State** 在执行完后会自动触发默认事件 **FINISHED**（谨慎使用，避免被当作路由）。

## 数据结构与 API 约定（强制）
- **`FsmString` 必须显式赋值 `Value`**：构造函数只设置“键/名字”，不包含“值”。

  - 错误：只有名字，没有值
    - `var s1 = new FsmString("StartShootSequence");`
  - 正确：名字与值同时设置
    - `var s2 = new FsmString("StartShootSequence") { Value = "StartShootSequence" };`

- **CallMethod**：被调用的 `method` 必须是 `public`，否则会报错。
- **新增 Variable 后**：必须重新初始化 `FsmVariables.Init();`。

## 实现与维护建议（推荐，优先采用）
- **优先使用 `FsmStateBuilder`** 来创建/查找 State 与 Transition，减少手写错误与重复逻辑。
- **添加事件/全局事件**：不使用反射；直接获取事件列表并插入即可。
- **在回答/实现中给出关键信息**：明确 FSM 名称、GameObject 名称、涉及的 States、Events、Transitions（至少列出修改/新增部分），并保证命名一致。

## 提交前自检清单（必须逐项满足）
- [ ] 顶部标签中的 **FSM 名称**、**GameObject 名称** 与实现一致。
- [ ] 所有 A→B 的跳转均由**单一事件**触发（无多事件收敛）。
- [ ] 未使用 **FINISHED** 作为多路通配事件。
- [ ] 所有 `FsmString` 均同步设置了 `Value`。
- [ ] Actions 与 State 职责清晰、无越界副作用；复杂逻辑已用中间状态拆分。

## 常见错误与修正（速查）
- 错误：`new FsmString("X")` 未赋值。→ 修正：`new FsmString("X") { Value = "X" }`
- 错误：从同一状态对同一目标状态注册多个不同事件。→ 修正：保留唯一事件或拆出中间状态。
