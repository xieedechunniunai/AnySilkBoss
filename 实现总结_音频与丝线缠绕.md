# 音频与丝线缠绕动画实现总结

## 实现日期
2024年11月17日

## 需求概述

### 1. 大丝球吸收小丝球音频
- 从原版反编译文件 `SilkSpool.cs` 中获取音频事件
- 在 `BigSilkBallCollisionBox` 中每次吸收小丝球时触发音频

### 2. 爬升阶段丝线缠绕动画
- 在爬升阶段开始禁用玩家时，使用 `Silk_yank` 物体显示丝线缠绕效果
- 在玩家周围四个方向（左上、左下、右上、右下）放置丝线
- 增强视觉效果，避免玩家直接掉落的生硬感

---

## 实现详情

### 1. 大丝球吸收音频 (`BigSilkBallCollisionBox.cs`)

#### 音频来源分析
从 `SilkSpool.cs` 反编译文件中发现两个可用的音频字段：
- `silkFailedAudioTable` (RandomAudioClipTable) - 第562行
- `cursedAudio` (AudioEvent) - 第587行

**选择方案**: 使用 `cursedAudio`，因为它是 AudioEvent 类型，更适合作为吸收音效。

#### 实现方法
在 `BigSilkBallCollisionBox.cs` 中添加了 `PlayAbsorbAudio()` 方法：

```csharp
private void PlayAbsorbAudio()
{
    try
    {
        // 通过 SilkSpool.Instance 获取音频事件
        var silkSpool = SilkSpool.Instance;
        if (silkSpool != null)
        {
            // 使用反射获取 cursedAudio 字段
            var audioField = silkSpool.GetType().GetField("cursedAudio", 
                System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            // 调用 SpawnAndPlayOneShot 方法播放音频
            // 使用 Audio.DefaultUIAudioSourcePrefab 作为音频源
        }
    }
    catch (System.Exception ex)
    {
        Log.Error($"播放吸收音效失败: {ex.Message}");
    }
}
```

#### 触发时机
在两个碰撞检测位置触发：
1. `OnTriggerEnter2D` - 碰撞箱主动检测
2. `OnCollisionWithSilkBall` - 小丝球主动报告碰撞

---

### 2. 爬升阶段丝线缠绕动画 (`PhaseControlBehavior.cs`)

#### 新增字段
```csharp
// 丝线缠绕动画相关
private GameObject? _silkYankPrefab;           // Silk_yank原始物体引用
private GameObject[] _silkYankClones = new GameObject[4];  // 四个克隆体
private bool _silkYankInitialized = false;      // 是否已初始化
```

#### 核心方法

##### 1. `InitializeSilkYankClones()`
- **调用时机**: 在 `AddClimbPhaseStates()` 末尾初始化
- **功能**: 
  - 查找路径: `Boss Scene/Rubble Fields/Rubble Field M/Silk_yank`
  - 创建4个克隆体，设为无父物体，初始禁用
  - 标记初始化完成

##### 2. `ActivateSilkYankAnimation()`
- **调用时机**: 在 `DisablePlayerInput()` 中调用
- **功能**:
  - 获取玩家位置
  - 在玩家周围四个方向放置丝线（偏移距离 2.5 单位）
  - 设置对应的旋转角度指向玩家中心
  
**位置和旋转配置**:
```csharp
// 四个位置：左上、左下、右上、右下
positions = {
    heroPos + (-2.5, +2.5, 0),   // 左上
    heroPos + (-2.5, -2.5, 0),   // 左下
    heroPos + (+2.5, +2.5, 0),   // 右上
    heroPos + (+2.5, -2.5, 0)    // 右下
}

// 四个旋转角度（指向玩家）
rotations = { 135°, -135°, 45°, -45° }
```

##### 3. `UpdateSilkYankPositions(float duration)`
- **调用时机**: 在启用丝线缠绕后立即调用
- **功能**: 
  - 协程，持续指定时间跟随玩家位置
  - 每帧更新四根丝线的位置和旋转
  - 保持相对玩家的偏移距离（10单位）
  - 应对玩家在空中下落的情况

##### 4. `DeactivateSilkYankAnimation()`
- **调用时机**: 在 `ClimbPhasePlayerAnimationCoroutine()` 中，玩家开始下落动画0.5秒后
- **功能**: 禁用所有四个丝线克隆体

#### 时间流程
```
进入协程
  ↓
启用丝线缠绕动画 (ActivateSilkYankAnimation) + 禁用玩家输入
  ↓
启动丝线跟随协程 (UpdateSilkYankPositions)
  ↓
等待 0.5 秒（丝线持续跟随玩家位置，玩家可能在空中下落）
  ↓
开始下落序列：设置穿墙图层、计算X轴速度、播放 Weak Fall 动画
  ↓
再等待 0.5 秒
  ↓
禁用丝线缠绕动画 (DeactivateSilkYankAnimation)
  ↓
玩家继续下落至落地...
```

---

## 技术要点

### 1. 反射使用
- 使用反射获取 `SilkSpool` 的私有字段 `cursedAudio`
- 使用反射获取静态类 `Audio` 的 `DefaultUIAudioSourcePrefab` 字段
- 使用反射调用 `AudioEvent.SpawnAndPlayOneShot` 方法

### 2. 动画自动播放机制
- `Silk_yank` 物体包含 `UnityEngine.Animator` 组件
- 启用物体 (`SetActive(true)`) 时会自动播放动画
- 动画播放完成后自动关闭物体
- 因此只需要控制物体的启用/禁用即可

### 3. 无父物体设计
- 丝线克隆体设置为无父物体 (`SetParent(null)`)
- 避免继承不必要的变换
- 便于独立控制位置和旋转

### 4. 丝线跟随机制
- 使用协程 `UpdateSilkYankPositions` 实现动态跟随
- 每帧更新丝线位置，保持相对玩家的固定偏移（10单位）
- 持续0.5秒跟随，应对玩家在空中下落的情况
- 偏移距离从原来的 2.5 单位增加到 10 单位，视觉效果更明显

---

## 视觉效果

### 爬升阶段流程
1. **四根丝线从四个角度向玩家缠绕 + 同时禁用输入** ← 新增视觉效果
2. **丝线持续跟随玩家0.5秒**（玩家可能在空中下落，丝线会跟随移动）← 动态跟随
3. **0.5秒后开始下落序列**：设置穿墙、播放 Weak Fall 动画
4. **再等0.5秒后丝线消失** ← 让玩家看到完整缠绕效果
5. **玩家继续下落并穿过平台**
6. **落地后恢复控制**

### 音效增强
- 每次大丝球吸收小丝球都会播放音效
- 增强反馈感和游戏体验
- 音效来源于原版游戏资源，保持风格一致

---

## 测试建议

### 音频测试
1. 启动大丝球大招
2. 观察吸收阶段是否有音效
3. 确认每次吸收都触发音效

### 丝线缠绕测试
1. 触发爬升阶段（P3阶段硬直）
2. 观察玩家被禁用时是否立即出现四根丝线
3. 确认丝线角度和位置正确
4. **测试丝线跟随**：观察玩家在空中时丝线是否跟随玩家移动（持续0.5秒）
5. 确认0.5秒后开始播放下落动画
6. 确认下落动画播放0.5秒后丝线消失
7. 确认整体视觉流畅性和时序正确

---

## 注意事项

1. **音频反射调用**: 如果原版更新修改了 `SilkSpool` 或 `Audio` 类的结构，可能需要调整反射代码
2. **Silk_yank路径**: 确保 `Boss Scene/Rubble Fields/Rubble Field M/Silk_yank` 路径正确
3. **性能**: 四个克隆体在场景中始终存在，但大部分时间处于禁用状态，对性能影响较小
4. **初始化时机**: 丝线缠绕在 `AddClimbPhaseStates()` 时初始化，确保爬升阶段功能可用
5. **偏移距离**: 丝线距离玩家10单位，可在 `ActivateSilkYankAnimation()` 和 `UpdateSilkYankPositions()` 中调整 `offsetDistance` 变量
6. **跟随时长**: 丝线跟随持续0.5秒，可根据实际玩家下落时间调整 `UpdateSilkYankPositions(0.5f)` 参数

---

## 文件修改清单

1. **BigSilkBallCollisionBox.cs**
   - 新增 `PlayAbsorbAudio()` 方法
   - 在 `OnTriggerEnter2D` 和 `OnCollisionWithSilkBall` 中调用

2. **PhaseControlBehavior.cs**
   - 新增字段: `_silkYankPrefab`, `_silkYankClones`, `_silkYankInitialized`
   - 新增方法: 
     - `InitializeSilkYankClones()` - 初始化丝线克隆体
     - `ActivateSilkYankAnimation()` - 启用丝线缠绕
     - `DeactivateSilkYankAnimation()` - 禁用丝线缠绕
     - `UpdateSilkYankPositions(float)` - 丝线跟随协程（新增）
   - 修改 `ClimbPhasePlayerAnimationCoroutine()` - 调整时序，添加丝线跟随逻辑
   - 修改 `AddClimbPhaseStates()` - 添加丝线缠绕初始化

---

## 结论

两个需求均已成功实现：
- ✅ 大丝球吸收小丝球时播放音效
- ✅ 爬升阶段禁用玩家时显示丝线缠绕动画

增强了游戏的视觉和听觉反馈，提升了整体游戏体验。
